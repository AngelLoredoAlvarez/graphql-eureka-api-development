CREATE OR REPLACE FUNCTION eureka_public.update_contracts_status() RETURNS VOID AS $$
    DECLARE
        client_contract eureka_public.client_contract;
        payment_movement eureka_public.client_contract_movement;
    BEGIN
        FOR client_contract IN
            SELECT
                *
            FROM
                eureka_public.client_contract
            WHERE
                TO_CHAR(end_date, 'DD-MM-YY') = TO_CHAR(NOW(), 'DD-MM-YYYY')
        LOOP
            IF NOT EXISTS(
                SELECT
                    1
                FROM
                    eureka_public.client_contract_movement
                WHERE
                    date
                BETWEEN
                    client_contract.start_date
                AND
                    client_contract.end_date
                AND
                    movement
                LIKE
                    'Adeudo'
            ) THEN
                UPDATE eureka_public.client_contract SET status = 'Finalizado' WHERE id = client_contract.id;
            END IF;
        END LOOP;

        FOR payment_movement IN
            SELECT
                *
            FROM
                eureka_public.client_contract_movement
            WHERE
                TO_CHAR(date, 'MM-YYYY') = TO_CHAR(NOW(), 'MM-YYYY')
            AND
                movement
            LIKE
                'Por Pagar'
        LOOP
            IF (TO_CHAR(payment_movement.date, 'DD-MM-YYYY') = TO_CHAR(NOW(), 'DD-MM-YYYY')) THEN
                UPDATE eureka_public.client_contract SET status = 'Por Pagar' WHERE id = payment_movement.id_contract;
            ELSEIF (TO_CHAR(payment_movement.date, 'DD-MM-YYYY') < TO_CHAR(NOW(), 'DD-MM-YYYY')) THEN
                UPDATE eureka_public.client_contract SET status = 'Adeudo' WHERE id = payment_movement.id_contract;
                UPDATE eureka_public.client_contract_movement SET movement = 'Adeudo' WHERE date = payment_movement.date AND id_contract = payment_movement.id_contract;
            END IF;
        END LOOP;
    END;
$$ LANGUAGE PLPGSQL VOLATILE;