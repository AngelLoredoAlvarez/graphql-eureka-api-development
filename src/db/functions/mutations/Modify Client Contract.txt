CREATE OR REPLACE FUNCTION eureka_public.modify_client_contract(
    business TEXT,
    id_town UUID,
    id_township UUID,
    id_street UUID,
    exterior_number TEXT,
    interior_number TEXT,
    type_contract TEXT,
    contacts eureka_public.contact[],
    id UUID
) RETURNS eureka_public.client_contract AS $$
    DECLARE
        modified_client_contract eureka_public.client_contract;
        translated_type_contract TEXT;
        contract_start_date TIMESTAMPTZ;
        business_contact eureka_public.contact;
    BEGIN
        IF $7 = '1 MES' THEN
            translated_type_contract = REPLACE($7, 'MES', 'MONTH');
        ELSE
            translated_type_contract = REPLACE($7, 'MESES', 'MONTHS');
        END IF;

        SELECT
            eureka_public.client_contract.start_date
        INTO
            contract_start_date
        FROM
            eureka_public.client_contract
        WHERE
            eureka_public.client_contract.id = $9;

        UPDATE
            eureka_public.client_contract
        SET
            business = $1,
            id_town = $2,
            id_township = $3,
            id_street = $4,
            exterior_number = $5,
            interior_number = $6,
            type_contract = $7,
            end_date = contract_start_date + translated_type_contract::INTERVAL
        WHERE
            client_contract.id = $9
        RETURNING
            *
        INTO
            modified_client_contract;

        DELETE FROM eureka_public.business_contact WHERE eureka_public.business_contact.id_contract = $9;

        IF ARRAY_LENGTH($8, 1) > 0 THEN
            FOREACH business_contact IN ARRAY $8 LOOP
                INSERT INTO eureka_public.business_contact(
                    type_contact,
                    contact,
                    id_contract
                ) VALUES(
                    business_contact.type_contact,
                    business_contact.contact,
                    $9
                );
            END LOOP;
        END IF;

        RETURN modified_client_contract;
    END;
$$ LANGUAGE PLPGSQL VOLATILE;